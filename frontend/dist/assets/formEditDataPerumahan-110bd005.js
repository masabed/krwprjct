import{L as S,P as C}from"./page-header-7252a4a4.js";import{K as v}from"./KecKelurahanList-556de1ec.js";import{i as T}from"./browser-image-compression-a3ab6596.js";import{S as f}from"./sweetalert2.esm.all-cdd2d7a4.js";import{_ as E,h as y,j as i,E as L,q as U,m as V,l as a,s as D,A as k,t as g,G as P,k as r,B as b,F as _,v as w,y as x,x as p,H as j}from"./index-234163e1.js";import"./logo-dark-92140013.js";import"./SIIMAH-e113b49b.js";const K={name:"FormEditDataPerumahan",components:{Layout:S,PageHeader:C},data(){return{kelurahanList:v,bidangOptions:["Perumahan","Pertanahan","Permukiman","Air Minum"],isCompressing:!1,selectedPhoto:null,originalForm:{},previewPhotos:[],previewPDFs:[],formData:{bidang:"",kegiatan:"",nik:"",nama_cpcl:"",dusun:"",kelurahan:"",kecamatan:"",no_surat:"",tanggal_sp:"",nilai_kontrak:null,jumlah_unit:null,type:"",kontraktor_pelaksana:"",tanggal_mulai:"",tanggal_selesai:"",waktu_kerja:null,pengawas_lapangan:"",pdfs:[],photos:[]},fieldLabels:{nik:"NIK",nama_cpcl:"Nama CPCL",kecamatan:"Kecamatan",kelurahan:"Kelurahan",dusun:"Dusun",no_surat:"No. Surat",tanggal_sp:"Tanggal SP",nilai_kontrak:"Nilai Kontrak",jumlah_unit:"Jumlah Unit",type:"Tipe",kontraktor_pelaksana:"Kontraktor Pelaksana",tanggal_mulai:"Tanggal Mulai",tanggal_selesai:"Tanggal Selesai",waktu_kerja:"Waktu Kerja (hari)",pengawas_lapangan:"Pengawas Lapangan"}}},mounted(){this.fetchExistingData()},methods:{inputType(o){return o.includes("tanggal")?"date":"text"},preventNegative(o){this.formData[o]<0&&(this.formData[o]=0)},formatDateTime(o){const t=o.match(/^(\d{8})(\d{6})_/);if(!t)return{date:"Format Tidak Valid",time:"-"};const[d,m,e]=t;return{date:`${m.slice(6,8)}/${m.slice(4,6)}/${m.slice(0,4)}`,time:`${e.slice(0,2)}:${e.slice(2,4)}:${e.slice(4,6)}`}},async fetchExistingData(){var d,m,e,u;const o=this.$route.params.id,t={}.VITE_ASSET_BASE_URL||"http://localhost:8000";try{const c=await this.$axios.get(`/perumahan/${o}`);if(c.data.success){const h=c.data.data;this.formData={...this.formData,...h,tanggal_sp:((d=h.tanggal_sp)==null?void 0:d.substring(0,10))||"",tanggal_mulai:((m=h.tanggal_mulai)==null?void 0:m.substring(0,10))||"",tanggal_selesai:((e=h.tanggal_selesai)==null?void 0:e.substring(0,10))||"",pdfs:[],photos:[]},await this.$nextTick(),!this.formData.kelurahan&&this.formData.kecamatan&&((u=v[this.formData.kecamatan])!=null&&u.length)&&(this.formData.kelurahan=v[this.formData.kecamatan][0]),this.originalForm=JSON.stringify(this.formData),this.previewPDFs=(h.pdfs||[]).map(s=>`${t}/storage/${s}`),this.previewPhotos=(h.photos||[]).map(s=>{const l=s.split("/").pop(),{date:n,time:F}=this.formatDateTime(l);return{url:`${t}/storage/${s}`,date:n,time:F}})}}catch(c){console.error("Fetch error:",c)}},async handleSinglePhoto(o){const t=o.target.files[0];if(t){if(this.formData.photos.length>=10){f.fire("Batas Foto","Maksimal 10 foto.","warning");return}this.isCompressing=!0;try{const d=await T(t,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0});this.formData.photos.push(d),this.previewPhotos.push({url:URL.createObjectURL(d),date:"Baru",time:"-"})}finally{this.isCompressing=!1}}},handlePDFs(o){const t=Array.from(o.target.files);this.formData.pdfs=t,this.previewPDFs=t.map(d=>d.name)},removePhoto(o){this.formData.photos.splice(o,1),this.previewPhotos.splice(o,1)},showPhoto(o){this.selectedPhoto=o},async submitForm(){var d;if(!this.formData.kecamatan||!this.formData.kelurahan)return f.fire("Validasi Gagal","Kecamatan dan Kelurahan wajib dipilih","warning");if(JSON.stringify(this.formData)===this.originalForm&&this.formData.photos.length===0&&this.formData.pdfs.length===0)return f.fire("Tidak Ada Perubahan","Tidak ada data yang diubah","info");const o=this.$route.params.id,t=new FormData;for(const m in this.formData){const e=this.formData[m];Array.isArray(e)?e.forEach(u=>t.append(`${m}[]`,u)):t.append(m,e)}try{(await this.$axios.post(`/perumahan/${o}`,t)).data.success?f.fire("Sukses","Data berhasil diperbarui","success").then(()=>{this.$router.push("/bidPerumahan/list")}):f.fire("Gagal","Gagal memperbarui data","error")}catch(m){console.error("Submit error:",((d=m.response)==null?void 0:d.data)||m),f.fire("Error","Gagal menyimpan data","error")}}}},B={class:"card"},N={class:"card-body"},A={class:"row"},M={class:"col-md-6 mb-3"},q=["value"],O={class:"col-md-6 mb-3"},G={key:0,class:"mb-3"},H={class:"form-label"},I=["onUpdate:modelValue","onInput"],W={key:1,class:"mb-3"},J={class:"form-label"},R=["value"],z={key:2,class:"mb-3"},Q={class:"form-label"},X=["value"],Y={key:3,class:"mb-3"},Z={class:"form-label"},$=["onUpdate:modelValue","type"],tt={class:"col-md-6 mb-3"},at={class:"mt-2"},et=["href"],st={class:"col-md-6 mb-3"},ot=["disabled"],nt={class:"mt-2 d-flex flex-wrap gap-2"},it=["src","onClick"],rt=["onClick"],lt={key:0,class:"progress mt-2"},mt={class:"text-end mt-3 d-flex justify-content-between"},ut=["disabled"],dt={class:"modal-content-custom"},pt=["src"],ht={class:"text-center text-muted"};function ct(o,t,d,m,e,u){const c=y("PageHeader"),h=y("Layout");return i(),L(h,null,{default:U(()=>[V(c,{title:"Edit Data Perumahan",items:[{text:"Menu"},{text:"Bidang Perumahan",href:"/bidPerumahan/list"},{text:"Edit",active:!0}]}),a("div",B,[a("div",N,[a("form",{onSubmit:t[7]||(t[7]=D((...s)=>u.submitForm&&u.submitForm(...s),["prevent"]))},[t[19]||(t[19]=a("div",{class:"alert alert-danger mb-3"},[k(" Semua form wajib diisi. "),a("strong",{class:"text-danger"},"Foto dan File Dokumen dapat diabaikan"),k(". ")],-1)),a("div",A,[a("div",M,[t[11]||(t[11]=a("label",{class:"form-label"},"Bidang",-1)),g(a("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>e.formData.bidang=s),class:"form-control",required:""},[t[10]||(t[10]=a("option",{disabled:"",value:""},"-- Pilih Bidang --",-1)),(i(!0),r(_,null,b(e.bidangOptions,s=>(i(),r("option",{key:s,value:s},p(s),9,q))),128))],512),[[P,e.formData.bidang]])]),a("div",O,[t[12]||(t[12]=a("label",{class:"form-label"},"Kegiatan",-1)),g(a("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>e.formData.kegiatan=s),type:"text",class:"form-control",required:""},null,512),[[w,e.formData.kegiatan]])]),(i(!0),r(_,null,b(e.fieldLabels,(s,l)=>(i(),r("div",{class:"col-md-6",key:l},[["nilai_kontrak","jumlah_unit","waktu_kerja"].includes(l)?(i(),r("div",G,[a("label",H,p(s),1),g(a("input",{"onUpdate:modelValue":n=>e.formData[l]=n,type:"number",class:"form-control",required:"",onInput:n=>u.preventNegative(l)},null,40,I),[[w,e.formData[l],void 0,{number:!0}]])])):l==="kecamatan"?(i(),r("div",W,[a("label",J,p(s),1),g(a("select",{"onUpdate:modelValue":t[2]||(t[2]=n=>e.formData.kecamatan=n),class:"form-control",required:""},[t[13]||(t[13]=a("option",{value:""},"-- Pilih Kecamatan --",-1)),(i(!0),r(_,null,b(Object.keys(e.kelurahanList),n=>(i(),r("option",{key:n,value:n},p(n),9,R))),128))],512),[[P,e.formData.kecamatan]])])):l==="kelurahan"?(i(),r("div",z,[a("label",Q,p(s),1),g(a("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>e.formData.kelurahan=n),class:"form-control",required:""},[t[14]||(t[14]=a("option",{value:""},"-- Pilih Kelurahan --",-1)),(i(!0),r(_,null,b(e.kelurahanList[e.formData.kecamatan]||[],n=>(i(),r("option",{key:n,value:n},p(n),9,X))),128))],512),[[P,e.formData.kelurahan]])])):(i(),r("div",Y,[a("label",Z,p(s),1),g(a("input",{"onUpdate:modelValue":n=>e.formData[l]=n,type:u.inputType(l),class:"form-control",required:""},null,8,$),[[j,e.formData[l]]])]))]))),128)),a("div",tt,[t[15]||(t[15]=a("label",{class:"form-label"},"Upload PDF",-1)),a("input",{type:"file",multiple:"",accept:".pdf",class:"form-control",onChange:t[4]||(t[4]=(...s)=>u.handlePDFs&&u.handlePDFs(...s))},null,32),a("ul",at,[(i(!0),r(_,null,b(e.previewPDFs,(s,l)=>(i(),r("li",{key:l},[a("a",{href:s,target:"_blank"},p(s.split("/").pop()),9,et)]))),128))])]),a("div",st,[t[17]||(t[17]=a("label",{class:"form-label"},"Ambil Foto",-1)),a("input",{type:"file",accept:"image/*",capture:"environment",class:"form-control",onChange:t[5]||(t[5]=(...s)=>u.handleSinglePhoto&&u.handleSinglePhoto(...s)),disabled:e.formData.photos.length>=10||e.isCompressing},null,40,ot),a("div",nt,[(i(!0),r(_,null,b(e.previewPhotos,(s,l)=>(i(),r("div",{key:l,class:"position-relative"},[a("img",{src:s.url,style:{width:"100px",height:"100px","object-fit":"cover",cursor:"pointer"},onClick:n=>u.showPhoto(s)},null,8,it),a("button",{class:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:D(n=>u.removePhoto(l),["prevent"])},"×",8,rt)]))),128))]),e.isCompressing?(i(),r("div",lt,t[16]||(t[16]=[a("div",{class:"progress-bar progress-bar-striped progress-bar-animated",style:{width:"100%"}}," Mengompres foto... ",-1)]))):x("",!0)])]),a("div",mt,[a("button",{class:"btn btn-light",onClick:t[6]||(t[6]=s=>o.$router.push("/bidPerumahan/list"))},"← Kembali"),a("button",{class:"btn btn-primary",type:"submit",disabled:e.isCompressing},t[18]||(t[18]=[a("i",{class:"mdi mdi-content-save me-1"},null,-1),k(" Update ")]),8,ut)])],32)])]),e.selectedPhoto?(i(),r("div",{key:0,class:"modal-backdrop",onClick:t[9]||(t[9]=D(s=>e.selectedPhoto=null,["self"]))},[a("div",dt,[a("img",{src:e.selectedPhoto.url,style:{"max-width":"100%","max-height":"60vh"},class:"mb-2"},null,8,pt),a("p",ht,[t[20]||(t[20]=k(" Di Upload pada Tanggal: ")),a("strong",null,p(e.selectedPhoto.date),1),t[21]||(t[21]=k(" Pukul ")),a("strong",null,p(e.selectedPhoto.time),1)]),a("button",{class:"btn btn-sm btn-secondary d-block mx-auto",onClick:t[8]||(t[8]=s=>e.selectedPhoto=null)},"Tutup")])])):x("",!0)]),_:1})}const Pt=E(K,[["render",ct],["__scopeId","data-v-3dcba093"]]);export{Pt as default};

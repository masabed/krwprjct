import{L as y,P as k}from"./page-header-7252a4a4.js";import{S as c}from"./sweetalert2.esm.all-cdd2d7a4.js";import{i as D}from"./browser-image-compression-a3ab6596.js";import{_ as x,h as _,j as r,E as P,q as C,m as F,l as e,k as n,F as p,B as h,y as b,A as S,s as w,x as u}from"./index-234163e1.js";import"./logo-dark-92140013.js";import"./SIIMAH-e113b49b.js";const L={name:"ViewPengawas",components:{Layout:y,PageHeader:k},data(){return{uid:this.$route.params.id,isCompressing:!1,loading:!0,formData:{photos:[],pdf_urls:[],photo_urls:[]},previewPhotos:[],fieldLabels:{nama_cpcl:"Nama CPCL",nik:"NIK",kegiatan:"Kegiatan",bidang:"Bidang",no_surat:"No. Surat",tanggal_sp:"Tanggal SP",nilai_kontrak:"Nilai Kontrak",jumlah_unit:"Jumlah Unit",type:"Tipe",kecamatan:"Kecamatan",kelurahan:"Kelurahan",dusun:"Dusun",tanggal_mulai:"Tanggal Mulai",tanggal_selesai:"Tanggal Selesai",waktu_kerja:"Waktu Kerja (hari)",pengawas_lapangan:"Pengawas Lapangan",kontraktor_pelaksana:"Kontraktor Pelaksana"}}},mounted(){this.fetchData()},methods:{getDateFromFilename(s){const t=s.split("/").pop(),a=t==null?void 0:t.split("_")[0];if(!a||a.length<12)return"-";const m=a.slice(0,4),o=a.slice(4,6),l=a.slice(6,8),g=a.slice(8,10),f=a.slice(10,12);return`${l}-${o}-${m} ${g}:${f}`},formatDateField(s,t){if(s.includes("tanggal")&&(t!=null&&t.includes("T"))){const[a]=t.split("T");return a.split("-").reverse().join("-")}return t},showPreviewModal(s){c.fire({imageUrl:s,imageAlt:"Preview Foto",showConfirmButton:!1,footer:`<small>Diunggah pada: ${this.getDateFromFilename(s)}</small>`})},async fetchData(){const s={}.VITE_ASSET_BASE_URL||"http://localhost:8000";this.loading=!0;try{const a=(await this.$axios.get(`/perumahan/${this.uid}`)).data.data;this.formData={...a,photos:[],pdf_urls:(a.pdfs||[]).map(m=>`${s}/storages/${m}`),photo_urls:(a.photos||[]).map(m=>`${s}/storage/${m}`)}}catch{c.fire("Gagal","Data gagal dimuat","error")}finally{this.loading=!1}},async handlePhotoUpload(s){const t=s.target.files[0];if(!(!t||this.formData.photos.length>=10)){this.isCompressing=!0;try{const a=await D(t,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0}),m=URL.createObjectURL(a),o=new Date().toLocaleString("id-ID");this.formData.photos.push(a),this.previewPhotos.push({url:m,time:o})}catch{c.fire("Error","Gagal mengompres foto","error")}finally{this.isCompressing=!1}}},removePhoto(s){this.formData.photos.splice(s,1),this.previewPhotos.splice(s,1)},async submitPhotos(){if(this.formData.photos.length<5){c.fire("Validasi","Minimal upload 5 foto","warning");return}const s=new FormData;this.formData.photos.forEach(t=>s.append("photos[]",t));try{(await this.$axios.post(`/perumahan/update-photos/${this.uid}`,s)).data.success?(c.fire("Sukses","Foto berhasil diupload","success"),this.formData.photos=[],this.previewPhotos=[],this.fetchData()):c.fire("Gagal","Foto gagal diupload","error")}catch{c.fire("Error","Terjadi kesalahan server","error")}}}},T={class:"card"},j={class:"card-body"},B={key:0,class:"text-center my-4"},E={class:"row"},U={class:"mb-3"},K={class:"form-label"},M=["value"],N={class:"col-md-6 mb-3"},V=["value"],A={class:"col-md-6 mb-3"},H={class:"mb-0"},I=["href"],W={class:"col-12 mb-3"},G={class:"d-flex flex-wrap gap-2"},R=["src","onClick"],$={class:"d-block text-muted",style:{"font-size":"0.75rem"}},z={class:"col-md-12 mb-3"},O=["disabled"],q={class:"mt-2 d-flex flex-wrap gap-2 justify-content-center"},J=["src"],Q={class:"badge bg-secondary d-block mt-1"},X=["onClick"],Y={key:0,class:"progress mt-2"},Z={class:"d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 mb-3"},tt=["disabled"];function et(s,t,a,m,o,l){const g=_("PageHeader"),f=_("Layout");return r(),P(f,null,{default:C(()=>[F(g,{title:"Data Pengawasan",items:[{text:"Menu"},{text:"Pengawasan",href:"/pengawas"},{text:"Detail",active:!0}]}),e("div",T,[e("div",j,[o.loading?(r(),n("div",B,t[3]||(t[3]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)]))):(r(),n("form",{key:1,onSubmit:t[2]||(t[2]=w((...i)=>l.submitPhotos&&l.submitPhotos(...i),["prevent"]))},[e("div",E,[s.key!=="kontraktor_pelaksana"?(r(!0),n(p,{key:0},h(o.fieldLabels,(i,d)=>(r(),n("div",{class:"col-md-6",key:d},[e("div",U,[e("label",K,u(i),1),e("input",{value:l.formatDateField(d,o.formData[d]),class:"form-control",disabled:""},null,8,M)])]))),128)):b("",!0),e("div",N,[t[4]||(t[4]=e("label",{class:"form-label"},"Bidang",-1)),e("input",{type:"text",class:"form-control",value:o.formData.bidang,disabled:""},null,8,V)]),e("div",A,[t[5]||(t[5]=e("label",{class:"form-label"},"Dokumen Terkait",-1)),e("ul",H,[(r(!0),n(p,null,h(o.formData.pdf_urls,(i,d)=>(r(),n("li",{key:d},[e("a",{href:i,target:"_blank",download:""},u(i.split("/").pop()),9,I)]))),128))])]),e("div",W,[t[6]||(t[6]=e("label",{class:"form-label"},"Foto Sebelumnya",-1)),e("div",G,[(r(!0),n(p,null,h(o.formData.photo_urls,(i,d)=>(r(),n("div",{key:"existing-"+d,class:"text-center",style:{"max-width":"110px"}},[e("img",{src:i,onClick:v=>l.showPreviewModal(i),style:{cursor:"pointer",width:"100px",height:"100px","object-fit":"cover"}},null,8,R),e("small",$," Diunggah: "+u(l.getDateFromFilename(i)),1)]))),128))])]),e("div",z,[t[8]||(t[8]=e("label",{class:"form-label"},"Tambah Foto (Kamera)",-1)),e("input",{type:"file",accept:"image/*",capture:"environment",class:"form-control",onChange:t[0]||(t[0]=(...i)=>l.handlePhotoUpload&&l.handlePhotoUpload(...i)),disabled:o.formData.photos.length>=10||o.isCompressing},null,40,O),e("div",q,[(r(!0),n(p,null,h(o.previewPhotos,(i,d)=>(r(),n("div",{key:"new-"+d,class:"position-relative text-center",style:{"max-width":"110px"}},[e("img",{src:i.url,style:{width:"100px",height:"100px","object-fit":"cover"}},null,8,J),e("span",Q,u(i.time),1),e("button",{class:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:w(v=>l.removePhoto(d),["prevent"])}," × ",8,X)]))),128))]),o.isCompressing?(r(),n("div",Y,t[7]||(t[7]=[e("div",{class:"progress-bar progress-bar-striped progress-bar-animated",style:{width:"100%"}}," Mengompres foto... ",-1)]))):b("",!0)])]),e("div",Z,[e("button",{class:"btn btn-secondary w-20 w-md-auto",type:"button",onClick:t[1]||(t[1]=i=>s.$router.back())}," ← Kembali "),e("button",{class:"btn btn-primary w-20 w-md-auto",type:"submit",disabled:o.formData.photos.length<5||o.isCompressing},t[9]||(t[9]=[e("i",{class:"mdi mdi-camera me-1"},null,-1),S(" Upload Foto ")]),8,tt)])],32))])])]),_:1})}const lt=x(L,[["render",et],["__scopeId","data-v-e3a63c8a"]]);export{lt as default};
